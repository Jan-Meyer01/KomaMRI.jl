steps:
  - label: "AMDGPU: Run tests on v{{matrix.version}}"
    matrix:
      setup:
        version:
          - "1.10"
    plugins:
      - JuliaCI/julia#v1:
          version: "{{matrix.version}}"
      - JuliaCI/julia-coverage#v1:
          codecov: true
          dirs:
            - KomaMRICore/src
            - KomaMRICore/ext
    command: |
      julia -e 'println("--- :julia: Instantiating project")
          using Pkg
          Pkg.develop([
              PackageSpec(path=pwd(), subdir="."),
              PackageSpec(path=pwd(), subdir="KomaMRIBase"),
              PackageSpec(path=pwd(), subdir="KomaMRICore"),
          ])'
      
      julia -e 'println("--- :julia: Running tests")
          using Pkg
          Pkg.test("KomaMRICore"; coverage=true, test_args=["AMDGPU"])'
    agents:
      queue: "juliagpu"
      rocm: "*"
    timeout_in_minutes: 120

  - label: "CUDA: Run tests on v{{matrix.version}}"
    matrix:
      setup:
        version:
          - "1.9"
    plugins:
      - JuliaCI/julia#v1:
          version: "{{matrix.version}}"
      - JuliaCI/julia-coverage#v1:
          codecov: true
          dirs:
            - KomaMRICore/src
            - KomaMRICore/ext
    command: |
      julia -e 'println("--- :julia: Instantiating project")
          using Pkg
          Pkg.develop([
              PackageSpec(path=pwd(), subdir="."),
              PackageSpec(path=pwd(), subdir="KomaMRIBase"),
              PackageSpec(path=pwd(), subdir="KomaMRICore"),
          ])'
      
      julia -e 'println("--- :julia: Running tests")
          using Pkg
          Pkg.test("KomaMRICore"; coverage=true, test_args=["CUDA"])'
    agents:
      queue: "juliagpu"
      cuda: "*"
    timeout_in_minutes: 120

  - label: "Metal: Run tests on v{{matrix.version}}"
    matrix:
      setup:
        version:
          - "1.9"
    plugins:
      - JuliaCI/julia#v1:
          version: "{{matrix.version}}"
      - JuliaCI/julia-coverage#v1:
          codecov: true
          dirs:
            - KomaMRICore/src
            - KomaMRICore/ext
    command: |
      julia -e 'println("--- :julia: Instantiating project")
          using Pkg
          Pkg.develop([
              PackageSpec(path=pwd(), subdir="."),
              PackageSpec(path=pwd(), subdir="KomaMRIBase"),
              PackageSpec(path=pwd(), subdir="KomaMRICore"),
          ])'
      
      julia -e 'println("--- :julia: Running tests")
          using Pkg
          Pkg.test("KomaMRICore"; coverage=true, test_args=["Metal"])'
    agents:
      queue: "juliaecosystem"
      os: "macos"
      arch: "aarch64"
    timeout_in_minutes: 120

  - label: "oneAPI: Run tests on v{{matrix.version}}"
    matrix:
      setup:
        version:
          - "1.9"
    plugins:
      - JuliaCI/julia#v1:
          version: "{{matrix.version}}"
      - JuliaCI/julia-coverage#v1:
          codecov: true
          dirs:
            - KomaMRICore/src
            - KomaMRICore/ext
    command: |
      julia -e 'println("--- :julia: Instantiating project")
          using Pkg
          Pkg.develop([
              PackageSpec(path=pwd(), subdir="."),
              PackageSpec(path=pwd(), subdir="KomaMRIBase"),
              PackageSpec(path=pwd(), subdir="KomaMRICore"),
          ])'
      
      julia -e 'println("--- :julia: Running tests")
          using Pkg
          Pkg.test("KomaMRICore"; coverage=true, test_args=["oneAPI"])'
    agents:
      queue: "juliagpu"
      intel: "*"
    timeout_in_minutes: 120

env:
  CI: BUILDKITE
  CODECOV_FLAGS: core
  SECRET_CODECOV_TOKEN: "zj5GwwVt93ZEJnyrzxSu7fdCgU6ZMWae9KwbUj04TSmMolCaF3nm5WX72DtADv7ghU2I+r7kAW6OzWQHSrNv6TfP85WN6ZHJ4RrSbT/RmwI10A4/AMZxVocrZORoLOXXPXUp3CYa/o6MzhusDrMRJKe+rt+Qvfr+u7EwLb9nYgaOdfgztMtCqiF9GSjXIisQMYvCvV1naBDy6IQdIYrw/nPbhf87djDFHdDP+oEA73GTL8BhvDrqF56PJzBHXCRB7tXQ+rp9mQh/qN1gvHOM2+V7QKXjQA37ClrpxCEu91OFCpfNSxKITGyrd1xAg4K8l0Nq4U8GQmU/hV37BRwCCg==;U2FsdGVkX1+goGno/OdGPOFyA54WyesQWnTsEdSCknV9sjBZE1YijuBpWHWHQYrlNa1mfl1VoDhy1TaHKnGejA=="