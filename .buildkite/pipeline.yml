steps:
  - label: "AMDGPU: Run tests on v{{matrix.version}}"
    matrix:
      setup:
        version:
          - "1.10"
    plugins:
      - JuliaCI/julia#v1:
          version: "{{matrix.version}}"
      - JuliaCI/julia-coverage#v1:
          codecov: true
          dirs:
            - KomaMRICore/src
            - KomaMRICore/ext
    command: |
      julia -e 'println("--- :julia: Instantiating project")
          using Pkg
          Pkg.develop([
              PackageSpec(path=pwd(), subdir="."),
              PackageSpec(path=pwd(), subdir="KomaMRIBase"),
              PackageSpec(path=pwd(), subdir="KomaMRICore"),
          ])'
      
      julia -e 'println("--- :julia: Running tests")
          using Pkg
          Pkg.test("KomaMRICore"; coverage=true, test_args=["AMDGPU"])'
    agents:
      queue: "juliagpu"
      rocm: "*"
    timeout_in_minutes: 120

  - label: "CUDA: Run tests on v{{matrix.version}}"
    matrix:
      setup:
        version:
          - "1.9"
    plugins:
      - JuliaCI/julia#v1:
          version: "{{matrix.version}}"
      - JuliaCI/julia-coverage#v1:
          codecov: true
          dirs:
            - KomaMRICore/src
            - KomaMRICore/ext
    command: |
      julia -e 'println("--- :julia: Instantiating project")
          using Pkg
          Pkg.develop([
              PackageSpec(path=pwd(), subdir="."),
              PackageSpec(path=pwd(), subdir="KomaMRIBase"),
              PackageSpec(path=pwd(), subdir="KomaMRICore"),
          ])'
      
      julia -e 'println("--- :julia: Running tests")
          using Pkg
          Pkg.test("KomaMRICore"; coverage=true, test_args=["CUDA"])'
    agents:
      queue: "juliagpu"
      cuda: "*"
    timeout_in_minutes: 120

  - label: "Metal: Run tests on v{{matrix.version}}"
    matrix:
      setup:
        version:
          - "1.9"
    plugins:
      - JuliaCI/julia#v1:
          version: "{{matrix.version}}"
      - JuliaCI/julia-coverage#v1:
          codecov: true
          dirs:
            - KomaMRICore/src
            - KomaMRICore/ext
    command: |
      julia -e 'println("--- :julia: Instantiating project")
          using Pkg
          Pkg.develop([
              PackageSpec(path=pwd(), subdir="."),
              PackageSpec(path=pwd(), subdir="KomaMRIBase"),
              PackageSpec(path=pwd(), subdir="KomaMRICore"),
          ])'
      
      julia -e 'println("--- :julia: Running tests")
          using Pkg
          Pkg.test("KomaMRICore"; coverage=true, test_args=["Metal"])'
    agents:
      queue: "juliaecosystem"
      os: "macos"
      arch: "aarch64"
    timeout_in_minutes: 120

  - label: "oneAPI: Run tests on v{{matrix.version}}"
    matrix:
      setup:
        version:
          - "1.9"
    plugins:
      - JuliaCI/julia#v1:
          version: "{{matrix.version}}"
      - JuliaCI/julia-coverage#v1:
          codecov: true
          dirs:
            - KomaMRICore/src
            - KomaMRICore/ext
    command: |
      julia -e 'println("--- :julia: Instantiating project")
          using Pkg
          Pkg.develop([
              PackageSpec(path=pwd(), subdir="."),
              PackageSpec(path=pwd(), subdir="KomaMRIBase"),
              PackageSpec(path=pwd(), subdir="KomaMRICore"),
          ])'
      
      julia -e 'println("--- :julia: Running tests")
          using Pkg
          Pkg.test("KomaMRICore"; coverage=true, test_args=["oneAPI"])'
    agents:
      queue: "juliagpu"
      intel: "*"
    timeout_in_minutes: 120

env:
  CI: BUILDKITE
  CODECOV_FLAGS: core
  SECRET_CODECOV_TOKEN: "uUW2pU78xML2A2BJ2XiKxFNfc9U6oi+LI8UyfPKitDxKOFD8iAagdimiHH/sETc6qJ8UUXAPvzID8Z9cpgL8UNolAiMvjf9kebCS5wbQlb0n+YkUpUzE16uDF8mhEiTuSc/R4WJ7x05f61A6L6JzEl51jGn+9KrMMI+S3UomaMHpbcyCxcxbcL3seYm24ikt0KSsTxfVvaoPSVVXpwjGrYa8hRtxUrnrnIXoIoOMgOzLlr7Puuik0BZDgOgo0NAltTmoFMaZtz4AQmFyi+JGQVp56ZctuiD8mjAtR0I4RRUt5/0Wvd9IT3ZqqT6sJUVZMdeRcUX97iV/8STJ40NYoQ==;U2FsdGVkX1/fX384FHt+KLaJfMVk2I7BDUAxPCqzHRON43EWqHAxRTeuKVI008JkFRyG+ICO+gnYYVHA+cdBTg=="
